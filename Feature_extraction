import os
import numpy as np
import scipy
from scipy.io import wavfile
import scipy.fftpack as fft
from scipy.signal import get_window
import IPython.display as ipd
import matplotlib.pyplot as plt
from sklearn import preprocessing
import python_speech_features as mfcc
import _pickle as cPickle
from scipy.io.wavfile import read
from sklearn.mixture import GaussianMixture as GMM
#from speakerfeatures import extract_features
import warnings

###################################### get the audio path 

TRAIN_PATH = './file/file/wav/audio.wav'
ipd.Audio(TRAIN_PATH)

###################################### get the audio sample rate and the audio duration 

sample_rate, audio = wavfile.read(TRAIN_PATH)
print("Sample rate: {0}Hz".format(sample_rate))
print("Audio duration: {0}s".format(len(audio) / sample_rate))

###################################### The code that extrate the MFCC from the audio file 

# -*- coding: utf-8 -*-
"""
Created on Mon Sep 14 19:26:59 2015
@author: Abhijeet Kumar
@code :  This program implemets feature (MFCC + delta)
         extraction process for an audio. 
@Note :  20 dim MFCC(19 mfcc coeff + 1 frame log energy)
         20 dim delta computation on MFCC features. 
@output : It returns 40 dimensional feature vectors for an audio.
"""

import numpy as np
from sklearn import preprocessing
import python_speech_features as mfcc

def calculate_delta(array):
    """Calculate and returns the delta of given feature vector matrix"""

    rows,cols = array.shape
    deltas = np.zeros((rows,20))
    N = 2
    for i in range(rows):
        index = []
        j = 1
        while j <= N:
            if i-j < 0:
                first = 0
            else:
                first = i-j
            if i+j > rows -1:
                second = rows -1
            else:
                second = i+j
            index.append((second,first))
            j+=1
        deltas[i] = ( array[index[0][0]]-array[index[0][1]] + (2 * (array[index[1][0]]-array[index[1][1]])) ) / 10
    return deltas

def extract_features(audio,rate):
    """extract 20 dim mfcc features from an audio, performs CMS and combines 
    delta to make it 40 dim feature vector"""    
    
    mfcc_feat = mfcc.mfcc(audio,rate, 0.025, 0.01,20,appendEnergy = True)
    
    mfcc_feat = preprocessing.scale(mfcc_feat)
    delta = calculate_delta(mfcc_feat)
    combined = np.hstack((mfcc_feat,delta)) 
    return combined
    
    ################################ print the mfcc array
    
    my_mfcc= extract_features(audio,sample_rate)
    print(my_mfcc)
    
    ################################ write the MFCC array into txt file 
    
    with open('extract_features.txt', 'w') as filehandle:
    for listitem in my_mfcc:
        filehandle.write('%s\n' % listitem)
        
